#map
%a{:href => '#'}
  =image_tag 'litography.png', :class => 'logo'
.overlay
  .story
    %a{:href => '#', :class => 'close-story'} X
    .story-text

%ul.top-bar.menu-bar
  %li
    %a.person.active{:href => '#'}
      =image_tag 'location/person-orange.png', :class => 'menu-icon'
  %li
    %a.place.active{:href => '#'}
      =image_tag 'location/place-orange.png', :class => 'menu-icon'
  %li
    %a.event.active{:href => '#'}
      =image_tag 'location/event-orange.png', :class => 'menu-icon'
  %li
    %a.other.active{:href => '#'}
      =image_tag 'location/other-orange.png', :class => 'menu-icon'
%ul.left-bar.menu-bar
  %li
    %a.audio.active{:href => '#'}
      =image_tag 'location/audio-orange.png', :class => 'menu-icon'
  %li
    %a.multimedia.active{:href => '#'}
      =image_tag 'location/multimedia-orange.png', :class => 'menu-icon'
  %li
    %a.visual.active{:href => '#'}
      =image_tag 'location/visual-orange.png', :class => 'menu-icon'

:javascript
  var menuImagePaths = {
    "person-text" : "#{ asset_path 'locations/person-text.png' }",
    "person-notext" : "#{ asset_path 'locations/person-notext.png' }",
    "person-orange" : "#{ asset_path 'locations/person-orange.png' }",
    "place-text" : "#{ asset_path 'locations/place-text.png' }",
    "place-notext" : "#{ asset_path 'locations/place-notext.png' }",
    "place-orange" : "#{ asset_path 'locations/place-orange.png' }",
    "event-text" : "#{ asset_path 'locations/event-text.png' }",
    "event-notext" : "#{ asset_path 'locations/event-notext.png' }",
    "event-orange" : "#{ asset_path 'locations/event-orange.png' }",
    "other-text" : "#{ asset_path 'locations/other-text.png' }",
    "other-notext" : "#{ asset_path 'locations/other-notext.png' }",
    "other-orange" : "#{ asset_path 'locations/other-orange.png' }",
    "audio-text" : "#{ asset_path 'locations/audio-text.png' }",
    "audio-notext" : "#{ asset_path 'locations/audio-notext.png' }",
    "audio-orange" : "#{ asset_path 'locations/audio-orange.png' }",
    "multimedia-text" : "#{ asset_path 'locations/multimedia-text.png' }",
    "multimedia-notext" : "#{ asset_path 'locations/multimedia-notext.png' }",
    "multimedia-orange" : "#{ asset_path 'locations/multimedia-orange.png' }",
    "visual-text" : "#{ asset_path 'visual-text.png' }",
    "visual-notext" : "#{ asset_path 'locations/visual-notext.png' }",
    "visual-orange" : "#{ asset_path 'locations/visual-orange.png' }",
  }
  $('.menu-bar').mouseenter(function() {
    $('.menu-icon').each(function(){
      this.src = this.src.replace(/(-)((?:[a-z][a-z]+))/, "-text");
    });
  });
  $('.menu-bar').mouseleave(function() {
    $('.menu-icon').each(function(){
      this.src = this.src.replace(/(-)((?:[a-z][a-z]+))/, "-notext");
    });
  });
  $('.menu-icon').mouseenter(function() {
    this.src = this.src.replace(/(-)((?:[a-z][a-z]+))/, "-orange");
  });
  $('.menu-icon').mouseleave(function() {
    this.src = this.src.replace(/(-)((?:[a-z][a-z]+))/, "-text");
  });

  litMap = Gmaps.build('Google');

  var mapStyles = 
  [
    {
      "elementType": "labels",
      "stylers": [
        { "visibility": "off" }
      ]
    },{
      "featureType": "water",
      "stylers": [
        { "color": "#b4dedd" }
      ]
    },{
      "featureType": "road.highway",
      "stylers": [
        { "visibility": "off" }
      ]
    },{
      "featureType": "road",
      "stylers": [
        { "color": "#b4dedd" }
      ]
    },{
      "featureType": "landscape",
      "stylers": [
        { "color": "#fcf8f5" }
      ]
    },{
      "featureType": "administrative",
      "stylers": [
        { "visibility": "off" }
      ]
    },{
      "featureType": "poi",
      "stylers": [
        { "visibility": "off" }
      ]
    },{
      "featureType": "transit",
      "stylers": [
        { "visibility": "off" }
      ]
    },{
      "featureType": "road.arterial",
      "stylers": [
        { "weight": 0.5 }
      ]
    }
  ];

  var markers;
  litMap.buildMap({ 
    provider: {
      styles: mapStyles,
      center: new google.maps.LatLng( 37.776414, -122.436157 ),
      zoom: 13,
      minZoom: 13,
      mapTypeControl: false,
      panControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT },
      streetViewControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT },
      zoomControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT },

    }, 
    internal: {id: 'map'}}, 
    function(){
      markers = #{raw @locationMarkers.to_json};
      litMap.addMarkers(markers);

      var mapObj = litMap.getMap()


      var bounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(37.678794,-122.618263),  //bottom left
        new google.maps.LatLng(37.841512,-122.345864)   //top right
      );

      google.maps.event.addListener(mapObj, 'dragend', function() {
        if (bounds.contains(mapObj.getCenter())) return;
        
        var c = mapObj.getCenter(),
          x = c.lng(),
          y = c.lat(),
          maxX = bounds.getNorthEast().lng(),
          maxY = bounds.getNorthEast().lat(),
          minX = bounds.getSouthWest().lng(),
          minY = bounds.getSouthWest().lat();

         if (x < minX) x = minX;
         if (x > maxX) x = maxX;
         if (y < minY) y = minY;
         if (y > maxY) y = maxY;

         mapObj.setCenter(new google.maps.LatLng(y, x));
      });
    });
  
  $('body').on('click', '.open-story', function(e) {
    e.preventDefault();

    $('.overlay').css('visibility', 'visible');

    var stories = $(e.target).attr('data-stories').split(',');
    var tabsHTML = '<ul class="nav nav-tabs">';
    var tabsContentHTML = '<div class="tab-content">';

    for(var story in stories) {
      if (story != 0) {
        tabsHTML += '<li><a href="#' + (parseInt(story)+1) + '" data-toggle="tab">' + (parseInt(story)+1) + '</a></li>';
        tabsContentHTML += '<div class="tab-pane ' + stories[story] + '" id="' + (parseInt(story)+1) + '"></div>';
      } else {
        tabsHTML += '<li class="active"><a href="#' + (parseInt(story)+1) + '" data-toggle="tab">' + (parseInt(story)+1) + '</a></li>';
        tabsContentHTML += '<div class="tab-pane active ' + stories[story] + '" id="' + (parseInt(story)+1) + '"></div>';
      }

    }

    tabsHTML += '</ul>';
    tabsContentHTML += '</div>';

    $('.story-text').html(tabsHTML + tabsContentHTML);

    for(var story in stories) {
      $.get("/stories/"+stories[story]+".json", function(data) {
        $('div.tab-pane.'+data.id).html(data.story_text);
      });
    }
    return false;
  });

  $('body').on('click', '.close-story', function(e) {
    e.preventDefault();
    $('.overlay').css('visibility', 'hidden');
    $('.story-text').html("");
    return false;
  });